# GitHub Actions workflow for SCA vulnerability scanning with Devin
# This workflow triggers a Devin session to run Snyk SCA scans on PRs

name: SCA Vulnerability Check

on:
  pull_request:
    branches: [main, master]

jobs:
  sca-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Devin SCA Check
        id: devin-sca
        run: |
          # Create a Devin session to run SCA vulnerability check
          RESPONSE=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "Run SCA vulnerability check on this PR. Repository: ${{ github.repository }}, PR #${{ github.event.pull_request.number }}, Branch: ${{ github.head_ref }}. Clone the repo, checkout the PR branch, and use the snyk_sca_scan tool to check for vulnerabilities. Report findings in structured output.",
              "playbook_id": "${{ vars.SCA_PLAYBOOK_ID }}",
              "idempotent": false
            }')
          
          # Extract session ID and URL
          SESSION_ID=$(echo $RESPONSE | jq -r '.session_id')
          SESSION_URL=$(echo $RESPONSE | jq -r '.url')
          
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "Devin session started: $SESSION_URL"

      - name: Wait for Devin to complete
        id: wait-devin
        run: |
          SESSION_ID="${{ steps.devin-sca.outputs.session_id }}"
          MAX_WAIT=600  # 10 minutes max
          ELAPSED=0
          POLL_INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS_RESPONSE=$(curl -s -X GET "https://api.devin.ai/v1/sessions/$SESSION_ID" \
              -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}")
            
            STATUS=$(echo $STATUS_RESPONSE | jq -r '.status')
            echo "Session status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" = "finished" ] || [ "$STATUS" = "blocked" ]; then
              # Get structured output
              STRUCTURED_OUTPUT=$(echo $STATUS_RESPONSE | jq -r '.structured_output // empty')
              
              if [ -n "$STRUCTURED_OUTPUT" ]; then
                CHECK_PASSED=$(echo $STRUCTURED_OUTPUT | jq -r '.check_passed // true')
                CHECK_NAME=$(echo $STRUCTURED_OUTPUT | jq -r '.check_name // "sca_vulnerability_check"')
                DETAILS=$(echo $STRUCTURED_OUTPUT | jq -r '.details // "No details provided"')
                
                echo "check_passed=$CHECK_PASSED" >> $GITHUB_OUTPUT
                echo "check_name=$CHECK_NAME" >> $GITHUB_OUTPUT
                echo "details=$DETAILS" >> $GITHUB_OUTPUT
              else
                echo "check_passed=true" >> $GITHUB_OUTPUT
                echo "details=Session completed without structured output" >> $GITHUB_OUTPUT
              fi
              break
            fi
            
            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "check_passed=false" >> $GITHUB_OUTPUT
            echo "details=Devin session timed out after ${MAX_WAIT}s" >> $GITHUB_OUTPUT
          fi

      - name: Report Results
        run: |
          echo "## SCA Vulnerability Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Session:** ${{ steps.devin-sca.outputs.session_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.wait-devin.outputs.check_passed == 'true' && 'Passed' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:** ${{ steps.wait-devin.outputs.details }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if vulnerabilities found
        if: steps.wait-devin.outputs.check_passed == 'false'
        run: |
          echo "SCA check failed: ${{ steps.wait-devin.outputs.details }}"
          exit 1
